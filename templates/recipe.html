{% extends "base.html" %}

{% block header %}
  View Dish
{% endblock %}

{% block content %}
  {% if recipe %}
    <div class="recipe-detail">
      <input class="field" type="text" value="{{ recipe.name }}" readonly />
      
      {% if recipe.ingredients %}
        <div class="recipe-card-info">
          <span><strong>Ingredients:</strong> {{ recipe.ingredients|join(', ') }}</span>
        </div>
      {% endif %}
      
      {% if recipe.prep_time %}
        <input class="field" type="text" value="Time to Cook: {{ recipe.prep_time }} minutes" readonly />
      {% endif %}

      {% if recipe.avg_rating %}
        <input class="field" type="text" value="Avg Rating: {{ recipe.avg_rating }} / 5 ({{ recipe.ratings|length }} ratings)" readonly />
      {% endif %}
      
      {% if recipe.instructions %}
        <textarea class="field" readonly rows="6">{% for step in recipe.instructions %}{{ step }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
      {% endif %}
      
<div class="rating-section">
  <form method="POST" action="{{ url_for('rate_recipe', recipe_id=recipe._id) }}">
    <label><strong>Rate this dish:</strong></label>
    <input class="field" type="number" name="rating" 
      min="1" max="5" 
      value="{{ recipe.ratings[current_user.id|string] if recipe.ratings and current_user.id|string in recipe.ratings else '' }}"
      placeholder="1-5" required />
    <button type="submit" class="button-background">
      <span class="button-text">
        {{ 'Edit Rating' if recipe.ratings and current_user.id|string in recipe.ratings else 'Submit Rating' }}
      </span>
    </button>
  </form>
</div>
      
      <div class="recipe-actions">
        <a href="{{ url_for('home') }}" class="button-background">
          <span class="button-text">Back to Home</span>
        </a>
        <a href="{{ url_for('edit_recipe', recipe_id=recipe._id) }}" class="button-background">
          <span class="button-text">Edit Recipe</span>
        </a>
        <a href="{{ url_for('delete_recipe', recipe_id=recipe._id) }}" class="button-background">
          <span class="button-text">Delete Recipe</span>
        </a>
        <form method="POST"
          action="{% if recipe._id in current_user_saved_ids %}
            {{ url_for('unsave_recipe', recipe_id=recipe._id) }}
          {% else %}
            {{ url_for('save_recipe', recipe_id=recipe._id) }}
          {% endif %}">
          <button type="submit" class="button-background">
            <span class="button-text">
              {% if recipe._id in current_user_saved_ids %}
                Unsave
              {% else %}
                Save
              {% endif %}
            </span>
          </button>
        </form>
      </div>
    </div>
  {% else %}
    <div class="error-message">
      <p>Recipe not found.</p>
      <a href="{{ url_for('home') }}" class="btn">Back to Home</a>
    </div>
  {% endif %}
{% endblock %}
