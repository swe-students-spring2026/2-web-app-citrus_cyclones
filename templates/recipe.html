{% extends "base.html" %}

{% block header %}
  View Dish
{% endblock %}

{% block content %}
  {% if recipe %}
    <div class="recipe-detail">
      <h2>{{ recipe.name }}</h2>
      
      {% if recipe.description %}
        <div class="recipe-card-info">
          <span><strong>Description:</strong> {{ recipe.description }}</span>
        </div>
      {% endif %}
      
      {% if recipe.ingredients %}
        <div class="recipe-card-info">
          <strong>Ingredients:</strong>
          <ul>
            {% for ingredient in recipe.ingredients %}
              <li>{{ ingredient }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      
      {% if recipe.prep_time %}
        <p><strong>Time to Cook:</strong> {{ recipe.prep_time }} minutes</p>
      {% endif %}

      {% if recipe.avg_rating %}
        <p><strong>Avg Rating:</strong> {{ recipe.avg_rating }} / 5 ({{ recipe.ratings|length }} ratings)</p>
      {% endif %}
      
      {% if recipe.instructions %}
        <div class="recipe-card-info">
          <strong>Instructions:</strong>
          <ol>
            {% for step in recipe.instructions %}
              <li>{{ step }}</li>
            {% endfor %}
          </ol>
        </div>
      {% endif %}
      
<div class="rating-section">
  <form method="POST" action="{{ url_for('rate_recipe', recipe_id=recipe._id) }}">
    <label><strong>Rate this dish:</strong></label>
    <input class="field" type="number" name="rating" 
      min="1" max="5" 
      value="{{ recipe.ratings[current_user.id|string] if recipe.ratings and current_user.id|string in recipe.ratings else '' }}"
      placeholder="1-5" required />
    <button type="submit" class="button-background">
      <span class="button-text">
        {{ 'Edit Rating' if recipe.ratings and current_user.id|string in recipe.ratings else 'Submit Rating' }}
      </span>
    </button>
  </form>
</div>
      
      <div class="recipe-actions">
        {% if from_profile %}
          <a href="{{ url_for('profile') }}" class="button-background">
            <span class="button-text">Back to profile</span>
          </a>
        {% else %}
          <a href="{{ url_for('home') }}" class="button-background">
            <span class="button-text">Back to Home</span>
          </a>
        {% endif %}
        
        <!-- show the view profile button iff this is not the current user's post -->
        {% if recipe.author_id != current_user.id %}
        <a href="{{ url_for('view_user_profile', user_id=user._id) }}" class="button-background">
          <span class="button-text"> View {{ user.username }}'s Profile </span>
        </a>
        {% endif %}

        {% if recipe.author_id == current_user.id %}
          <a href="{{ url_for('edit_recipe', recipe_id=recipe._id) }}" class="button-background">
            <span class="button-text">Edit Recipe</span>
          </a>
          <a href="{{ url_for('delete_recipe', recipe_id=recipe._id) }}" class="button-background">
            <span class="button-text">Delete Recipe</span>
          </a>
        {% endif %}
        <form method="POST"
          action="{% if recipe._id in current_user_saved_ids %}
            {{ url_for('unsave_recipe', recipe_id=recipe._id) }}
          {% else %}
            {{ url_for('save_recipe', recipe_id=recipe._id) }}
          {% endif %}">
          <button type="submit" class="button-background">
            <span class="button-text">
              {% if recipe._id in current_user_saved_ids %}
                Unsave
              {% else %}
                Save
              {% endif %}
            </span>
          </button>
        </form>
      </div>
    </div>
  {% else %}
    <div class="error-message">
      <p>Recipe not found.</p>
      <a href="{{ url_for('home') }}" class="btn">Back to Home</a>
    </div>
  {% endif %}
{% endblock %}
